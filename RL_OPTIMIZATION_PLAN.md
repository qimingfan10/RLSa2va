# Sa2VA å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–æ–¹æ¡ˆ

## ðŸ“Š å½“å‰çŠ¶æ€åˆ†æž

### æ€§èƒ½æŒ‡æ ‡
- **Dice Score**: 0.8191
- **IoU**: 0.6959
- **Precision**: 0.8742 âœ… (é«˜)
- **Recall**: 0.7763 âš ï¸ (ä½Ž - ä¸»è¦é—®é¢˜)
- **æˆåŠŸçŽ‡**: 100%

### æ ¸å¿ƒé—®é¢˜
**Recallåä½Ž** æ„å‘³ç€æœ‰çº¦22%çš„è¡€ç®¡åƒç´ æœªè¢«æ£€æµ‹åˆ°ï¼Œè¿™è¡¨æ˜Žæ¨¡åž‹åœ¨ä»¥ä¸‹æ–¹é¢å­˜åœ¨ä¸è¶³ï¼š
1. å¯¹ç»†å°è¡€ç®¡åˆ†æ”¯çš„æ•æ„Ÿåº¦ä¸å¤Ÿ
2. ä½Žå¯¹æ¯”åº¦åŒºåŸŸçš„æ£€æµ‹èƒ½åŠ›å¼±
3. è¡€ç®¡è¾¹ç¼˜çš„è¯†åˆ«ä¸å®Œæ•´

---

## ðŸŽ¯ RLä¼˜åŒ–ç­–ç•¥ï¼ˆ3ä¸ªæ–¹æ¡ˆï¼‰

### æ–¹æ¡ˆ1ï¼šPromptä¼˜åŒ–å¼ºåŒ–å­¦ä¹ ï¼ˆæŽ¨èâ­â­â­â­â­ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šä½¿ç”¨RLå­¦ä¹ æ›´å¥½çš„æ–‡æœ¬promptç­–ç•¥ï¼Œå¼•å¯¼Sa2VAç”Ÿæˆæ›´å®Œæ•´çš„åˆ†å‰²ç»“æžœã€‚

#### æž¶æž„è®¾è®¡
```
çŽ¯å¢ƒçŠ¶æ€(State): 
- å½“å‰å›¾åƒç‰¹å¾
- å½“å‰åˆ†å‰²mask
- ä¸ŽGTçš„å·®å¼‚åŒºåŸŸï¼ˆé—æ¼åŒºåŸŸï¼‰
- åŽ†å²promptæ•ˆæžœ

åŠ¨ä½œç©ºé—´(Action):
- åŸºç¡€prompt: "segment the blood vessel"
- å¢žå¼ºprompt: "segment all blood vessels including thin branches"
- è¾¹ç¼˜å¢žå¼º: "segment blood vessel with precise boundaries"
- å¯¹æ¯”åº¦é€‚åº”: "segment blood vessel in low contrast regions"
- ç»†èŠ‚å¼ºè°ƒ: "carefully segment small vessel branches"
- ç»„åˆpromptç­–ç•¥

å¥–åŠ±å‡½æ•°(Reward):
- ä¸»è¦: Diceæå‡é‡ (æƒé‡0.4)
- Recallæå‡ (æƒé‡0.3)
- Precisionä¿æŒ (æƒé‡0.1)
- clDice (ä¸­å¿ƒçº¿è¿žç»­æ€§, æƒé‡0.2)
```

#### ä¼˜åŠ¿
- âœ… **ä¸éœ€è¦ä¿®æ”¹æ¨¡åž‹å‚æ•°**ï¼šåªä¼˜åŒ–promptç­–ç•¥
- âœ… **å¿«é€Ÿè®­ç»ƒ**ï¼šçŠ¶æ€ç©ºé—´å°ï¼Œæ”¶æ•›å¿«
- âœ… **å¯è§£é‡Šæ€§å¼º**ï¼šæ¯ä¸ªåŠ¨ä½œå¯¹åº”æ˜Žç¡®çš„è¯­ä¹‰
- âœ… **è®¡ç®—æˆæœ¬ä½Ž**ï¼šåªéœ€è¦å¤šæ¬¡æŽ¨ç†ï¼Œä¸éœ€è¦åå‘ä¼ æ’­

#### å®žçŽ°æ­¥éª¤
1. åˆ›å»ºpromptç­–ç•¥åº“ï¼ˆ10-20ä¸ªå€™é€‰promptï¼‰
2. è®¾è®¡RLçŽ¯å¢ƒï¼ˆåŸºäºŽGymnasiumï¼‰
3. ä½¿ç”¨PPOè®­ç»ƒç­–ç•¥ç½‘ç»œ
4. è¯„ä¼°æœ€ä¼˜promptç»„åˆ

---

### æ–¹æ¡ˆ2ï¼šåŽå¤„ç†ä¼˜åŒ–å¼ºåŒ–å­¦ä¹ ï¼ˆæŽ¨èâ­â­â­â­ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šä½¿ç”¨RLä¼˜åŒ–Sa2VAè¾“å‡ºmaskçš„åŽå¤„ç†æ­¥éª¤ï¼Œæé«˜Recallã€‚

#### æž¶æž„è®¾è®¡
```
çŽ¯å¢ƒçŠ¶æ€(State):
- Sa2VAåŽŸå§‹è¾“å‡ºmask
- åŽŸå§‹å›¾åƒ
- è¡€ç®¡æ€§ç‰¹å¾å›¾ï¼ˆFrangi vesselnessï¼‰
- ä¸ç¡®å®šæ€§å›¾

åŠ¨ä½œç©ºé—´(Action):
- é˜ˆå€¼è°ƒæ•´: é™ä½ŽmaskäºŒå€¼åŒ–é˜ˆå€¼ï¼ˆå¢žåŠ Recallï¼‰
- å½¢æ€å­¦æ“ä½œ: è†¨èƒ€/è…èš€/é—­è¿ç®—
- è¿žé€šæ€§ä¿®å¤: è¿žæŽ¥æ–­è£‚çš„è¡€ç®¡æ®µ
- åŒºåŸŸå¢žé•¿: ä»Žé«˜ç½®ä¿¡åº¦åŒºåŸŸå‘å¤–æ‰©å±•
- è¡€ç®¡æ€§å¼•å¯¼: ä½¿ç”¨Frangi vesselnessè¡¥å……ç»†è¡€ç®¡

å¥–åŠ±å‡½æ•°(Reward):
- Diceæå‡é‡ (æƒé‡0.4)
- Recallæå‡ (æƒé‡0.3)
- Precisionä¿æŒæƒ©ç½š (æƒé‡0.2)
- æ‹“æ‰‘è¿žç»­æ€§ (æƒé‡0.1)
```

#### ä¼˜åŠ¿
- âœ… **ä¸ä¿®æ”¹æ¨¡åž‹**ï¼šç‹¬ç«‹çš„åŽå¤„ç†æ¨¡å—
- âœ… **å¯æŽ§æ€§å¥½**ï¼šå¯ä»¥è°ƒæ•´Precision-Recallå¹³è¡¡
- âœ… **é€šç”¨æ€§å¼º**ï¼šé€‚ç”¨äºŽä»»ä½•åˆ†å‰²æ¨¡åž‹
- âœ… **å®žæ—¶æ€§å¥½**ï¼šæŽ¨ç†é€Ÿåº¦å¿«

#### å®žçŽ°æ­¥éª¤
1. å®žçŽ°åŽå¤„ç†åŠ¨ä½œåº“
2. è®¾è®¡å¥–åŠ±å‡½æ•°ï¼ˆå¹³è¡¡Precisionå’ŒRecallï¼‰
3. ä½¿ç”¨PPO/DQNè®­ç»ƒç­–ç•¥
4. åœ¨éªŒè¯é›†ä¸Šä¼˜åŒ–è¶…å‚æ•°

---

### æ–¹æ¡ˆ3ï¼šReward Networkå¼•å¯¼å¾®è°ƒï¼ˆæŽ¨èâ­â­â­ï¼ŒåŸºäºŽRL4Seg3Dï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šè®­ç»ƒä¸€ä¸ªå¥–åŠ±ç½‘ç»œè¯„ä¼°åˆ†å‰²è´¨é‡ï¼Œç„¶åŽç”¨PPOå¾®è°ƒSa2VAæ¨¡åž‹ã€‚

#### æž¶æž„è®¾è®¡ï¼ˆå‚è€ƒRL4Seg3Dï¼‰
```
æ­¥éª¤1: ç”Ÿæˆå¥–åŠ±æ•°æ®é›†
- ä½¿ç”¨Sa2VAåœ¨è®­ç»ƒé›†ä¸Šé¢„æµ‹
- åˆ›å»ºæ­£è´Ÿæ ·æœ¬å¯¹ï¼š
  * æ­£æ ·æœ¬: Dice > 0.85
  * è´Ÿæ ·æœ¬: Dice < 0.75
  * æ··åˆæ ·æœ¬: 0.75 <= Dice <= 0.85

æ­¥éª¤2: è®­ç»ƒReward Network
è¾“å…¥: å›¾åƒ + åˆ†å‰²mask
è¾“å‡º: è´¨é‡åˆ†æ•° (0-1)
æŸå¤±: ç›‘ç£å­¦ä¹  (MSE/Binary Cross-Entropy)

æ­¥éª¤3: PPOå¾®è°ƒSa2VA
- ä½¿ç”¨Reward Networkæä¾›å¥–åŠ±ä¿¡å·
- å¾®è°ƒSa2VAçš„decoderéƒ¨åˆ†ï¼ˆfrozen_sam2_decoder=Falseï¼‰
- æˆ–è€…å¾®è°ƒLoRAå‚æ•°
```

#### ä¼˜åŠ¿
- âœ… **æ€§èƒ½æå‡ç©ºé—´å¤§**ï¼šç›´æŽ¥ä¼˜åŒ–æ¨¡åž‹å‚æ•°
- âœ… **æœ‰æˆç†Ÿæ¡†æž¶å‚è€ƒ**ï¼šRL4Seg3Då·²éªŒè¯
- âœ… **é€‚åˆå¤§è§„æ¨¡ä¼˜åŒ–**ï¼šå¯è¿­ä»£è®­ç»ƒ

#### åŠ£åŠ¿
- âš ï¸ **è®­ç»ƒæˆæœ¬é«˜**ï¼šéœ€è¦GPUèµ„æºå’Œæ—¶é—´
- âš ï¸ **å¯èƒ½è¿‡æ‹Ÿåˆ**ï¼šéœ€è¦å¤§é‡è®­ç»ƒæ•°æ®
- âš ï¸ **ç¨³å®šæ€§æŒ‘æˆ˜**ï¼šRLè®­ç»ƒå¯èƒ½ä¸ç¨³å®š

---

## ðŸš€ æŽ¨èå®žæ–½è·¯çº¿

### ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€ŸéªŒè¯ï¼ˆ1-2å¤©ï¼‰
**é€‰æ‹©æ–¹æ¡ˆ1 - Promptä¼˜åŒ–**

**åŽŸå› **ï¼š
- æœ€å¿«éªŒè¯RLçš„å¯è¡Œæ€§
- ä¸éœ€è¦ä¿®æ”¹æ¨¡åž‹
- å¯ä»¥ç«‹å³çœ‹åˆ°æ•ˆæžœ

**å®žçŽ°**ï¼š
```python
# å€™é€‰promptåº“
prompts = [
    "segment the blood vessel",
    "segment all blood vessels including small branches",
    "carefully segment blood vessel with thin branches",
    "segment blood vessel and its bifurcations",
    "detect and segment complete vascular structure",
    # ... æ›´å¤šå˜ä½“
]

# RLçŽ¯å¢ƒ
class PromptOptimizationEnv(gym.Env):
    def __init__(self, model, dataset):
        self.action_space = Discrete(len(prompts))
        self.observation_space = Box(...)  # å›¾åƒç‰¹å¾
        
    def step(self, action):
        prompt = prompts[action]
        pred_mask = self.model.predict(image, prompt)
        reward = calculate_reward(pred_mask, gt_mask)
        return obs, reward, done, info
```

### ç¬¬äºŒé˜¶æ®µï¼šå¢žå¼ºä¼˜åŒ–ï¼ˆ3-5å¤©ï¼‰
**ç»“åˆæ–¹æ¡ˆ1å’Œæ–¹æ¡ˆ2**

1. ä½¿ç”¨æœ€ä¼˜promptè¿›è¡ŒæŽ¨ç†
2. åº”ç”¨RLä¼˜åŒ–çš„åŽå¤„ç†
3. åœ¨éªŒè¯é›†ä¸Šè¯„ä¼°æ•ˆæžœ

### ç¬¬ä¸‰é˜¶æ®µï¼šæ·±åº¦ä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰
**å¦‚æžœå‰ä¸¤é˜¶æ®µæ•ˆæžœä¸è¶³ï¼Œå®žæ–½æ–¹æ¡ˆ3**

è®­ç»ƒReward Network + PPOå¾®è°ƒ

---

## ðŸ“ å¥–åŠ±å‡½æ•°è®¾è®¡

### ç»¼åˆå¥–åŠ±å‡½æ•°
```python
def calculate_reward(pred_mask, gt_mask, prev_dice):
    """
    ç»¼åˆå¥–åŠ±å‡½æ•°ï¼Œå¹³è¡¡å¤šä¸ªç›®æ ‡
    """
    # 1. Diceæå‡å¥–åŠ±
    dice = dice_score(pred_mask, gt_mask)
    dice_improvement = dice - prev_dice
    reward_dice = dice_improvement * 10.0  # æ”¾å¤§å¥–åŠ±
    
    # 2. Recallæå‡å¥–åŠ±ï¼ˆé‡ç‚¹ï¼‰
    recall = recall_score(pred_mask, gt_mask)
    recall_target = 0.85  # ç›®æ ‡Recall
    reward_recall = max(0, recall - recall_target) * 5.0
    
    # 3. Precisionä¿æŒæƒ©ç½š
    precision = precision_score(pred_mask, gt_mask)
    if precision < 0.85:  # ä¸èƒ½ç‰ºç‰²å¤ªå¤šPrecision
        penalty_precision = (0.85 - precision) * 3.0
    else:
        penalty_precision = 0
    
    # 4. clDiceå¥–åŠ±ï¼ˆè¡€ç®¡ä¸­å¿ƒçº¿è¿žç»­æ€§ï¼‰
    cldice = centerline_dice(pred_mask, gt_mask)
    reward_cldice = cldice * 2.0
    
    # 5. æ‹“æ‰‘æƒ©ç½š
    n_components = count_connected_components(pred_mask)
    penalty_topology = max(0, n_components - 5) * 0.5
    
    # æ€»å¥–åŠ±
    total_reward = (
        reward_dice +
        reward_recall +
        reward_cldice -
        penalty_precision -
        penalty_topology
    )
    
    return total_reward
```

---

## ðŸ› ï¸ æŠ€æœ¯æ ˆ

### å¿…éœ€åº“
```bash
pip install stable-baselines3 gymnasium
pip install scikit-image opencv-python
pip install tensorboard
```

### å»ºè®®çš„RLç®—æ³•
- **PPO** (Proximal Policy Optimization): ç¨³å®šã€é€šç”¨ âœ…
- **SAC** (Soft Actor-Critic): é€‚åˆè¿žç»­åŠ¨ä½œç©ºé—´
- **DQN**: é€‚åˆç¦»æ•£åŠ¨ä½œç©ºé—´

---

## ðŸ“Š é¢„æœŸæ•ˆæžœ

### æ–¹æ¡ˆ1 (Promptä¼˜åŒ–)
- Diceæå‡: **+2-5%** â†’ 0.84-0.86
- Recallæå‡: **+3-6%** â†’ 0.81-0.84
- è®­ç»ƒæ—¶é—´: **å‡ å°æ—¶**

### æ–¹æ¡ˆ2 (åŽå¤„ç†ä¼˜åŒ–)
- Diceæå‡: **+3-7%** â†’ 0.85-0.88
- Recallæå‡: **+5-10%** â†’ 0.83-0.88
- è®­ç»ƒæ—¶é—´: **1-2å¤©**

### æ–¹æ¡ˆ3 (Reward Networkå¾®è°ƒ)
- Diceæå‡: **+5-10%** â†’ 0.87-0.92
- Recallæå‡: **+8-15%** â†’ 0.86-0.92
- è®­ç»ƒæ—¶é—´: **1-2å‘¨**

---

## ðŸŽ“ å‚è€ƒèµ„æ–™

### å·²æœ‰é¡¹ç›®
1. **RL4Seg3D** (`/home/ubuntu/RL4Seg3D/`)
   - 3Dåˆ†å‰²çš„RLæ¡†æž¶
   - Reward Networkè®­ç»ƒ
   - PPOå¾®è°ƒç­–ç•¥

2. **sam+RL** (`/home/ubuntu/sam+RL/`)
   - SAM2 + RLå€™é€‰é€‰æ‹©
   - Promptç­–ç•¥å­¦ä¹ 
   - clDiceç­‰å¥–åŠ±å‡½æ•°

### è®ºæ–‡å‚è€ƒ
- RL4Seg: https://arxiv.org/abs/2406.17902
- clDice: https://arxiv.org/abs/2003.07311
- PPO: https://arxiv.org/abs/1707.06347

---

## ðŸ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **é€‰æ‹©æ–¹æ¡ˆ**ï¼šå»ºè®®ä»Žæ–¹æ¡ˆ1å¼€å§‹
2. **åˆ›å»ºçŽ¯å¢ƒ**ï¼šå®žçŽ°GymnasiumçŽ¯å¢ƒ
3. **å®šä¹‰å¥–åŠ±**ï¼šå®žçŽ°å¥–åŠ±å‡½æ•°
4. **è®­ç»ƒç­–ç•¥**ï¼šä½¿ç”¨PPOè®­ç»ƒ
5. **è¯„ä¼°éªŒè¯**ï¼šåœ¨10å¼ æµ‹è¯•å›¾ç‰‡ä¸ŠéªŒè¯
6. **æ‰©å±•æµ‹è¯•**ï¼šåœ¨å…¨æ•°æ®é›†ä¸Šæµ‹è¯•

---

## ðŸ’¡ å…³é”®ä¼˜åŒ–ç‚¹

### é’ˆå¯¹Recallä½Žçš„é—®é¢˜
1. **é™ä½Žé˜ˆå€¼ç­–ç•¥**ï¼šåŠ¨æ€è°ƒæ•´maskäºŒå€¼åŒ–é˜ˆå€¼
2. **å¤šå°ºåº¦èžåˆ**ï¼šç»“åˆä¸åŒå°ºåº¦çš„é¢„æµ‹
3. **è¡€ç®¡æ€§å¢žå¼º**ï¼šä½¿ç”¨Frangi vesselnessè¡¥å……
4. **åŒºåŸŸå¢žé•¿**ï¼šä»Žé«˜ç½®ä¿¡åº¦åŒºåŸŸæ‰©å±•
5. **promptå·¥ç¨‹**ï¼šå¼ºè°ƒ"ç»†å°åˆ†æ”¯"ã€"å®Œæ•´ç»“æž„"

### ä¿æŒPrecisionçš„ç­–ç•¥
1. **è½¯çº¦æŸ**ï¼šå¥–åŠ±å‡½æ•°ä¸­åŠ å…¥Precisioné¡¹
2. **ç½®ä¿¡åº¦è¿‡æ»¤**ï¼šåªæ‰©å±•é«˜ç½®ä¿¡åº¦åŒºåŸŸ
3. **å½¢æ€å­¦çº¦æŸ**ï¼šé™åˆ¶è†¨èƒ€æ“ä½œçš„èŒƒå›´

---

**åˆ›å»ºæ—¶é—´**: 2025-11-29  
**ç›®æ ‡**: å°†Diceä»Ž0.82æå‡åˆ°0.85+ï¼ŒRecallä»Ž0.78æå‡åˆ°0.85+  
**å»ºè®®**: å…ˆå®žæ–½æ–¹æ¡ˆ1è¿›è¡Œå¿«é€ŸéªŒè¯
