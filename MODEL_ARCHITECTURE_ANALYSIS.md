# Sa2VAæ¨¡å‹æ¶æ„åˆ†æ

## ğŸ” è®­ç»ƒé…ç½®è¯¦è§£

### é…ç½®æ–‡ä»¶ï¼š`sa2va_vessel_finetune.py`

```python
# ç¬¬24-28è¡Œ
# Model - ä½¿ç”¨InternVL3-8Bä½œä¸ºåŸºç¡€æ¨¡å‹
# æ³¨æ„ï¼šé¢„è®­ç»ƒæƒé‡æ¥è‡ª26Bæ¨¡å‹
path = ".../InternVL3-8B/snapshots/..."          # â† 8Bæ¶æ„
pretrained_pth = "/home/ubuntu/Sa2VA-26B.pth"     # â† 26Bé¢„è®­ç»ƒæƒé‡
```

---

## ğŸ“ æ¨¡å‹ç»„æˆ

### å®Œæ•´æ¶æ„ï¼ˆ~14Bå‚æ•°ï¼‰

```
Sa2VAæ¨¡å‹
â”œâ”€â”€ Vision Encoder: InternViT-6B (6Bå‚æ•°)
â”‚   â””â”€â”€ æ¥è‡ª InternVL3-8B
â”œâ”€â”€ Language Model: InternLM2-8B (8Bå‚æ•°) 
â”‚   â””â”€â”€ æ¥è‡ª InternVL3-8B
â”œâ”€â”€ Projector: 2å±‚MLP (~10Må‚æ•°)
â””â”€â”€ SAM2 Decoder: SAM2-Large (~200Må‚æ•°)

æ€»è®¡: ~14Bå‚æ•°
```

---

## ğŸ¯ å®é™…æƒ…å†µ

### 1. **åŸºç¡€æ¶æ„ï¼š8B**
```python
# ä½¿ç”¨InternVL3-8Bçš„æ¨¡å‹æ¶æ„
path = "/home/ubuntu/huggingface_cache/.../InternVL3-8B/..."
```

**å«ä¹‰**ï¼š
- Vision Encoder: InternViT-6B
- Language Model: InternLM2-8B (å®é™…æ˜¯Qwen2.5-7B)
- æ€»å‚æ•°ï¼š~14B

### 2. **é¢„è®­ç»ƒæƒé‡ï¼š26B**
```python
pretrained_pth = "/home/ubuntu/Sa2VA-26B.pth"
```

**åŠ è½½é€»è¾‘**ï¼ˆåœ¨`sa2va.py`ç¬¬72-87è¡Œï¼‰ï¼š
```python
if pretrained_pth is not None:
    pretrained_state_dict = guess_load_checkpoint(pretrained_pth)
    # è¿‡æ»¤å½¢çŠ¶ä¸åŒ¹é…çš„æƒé‡
    for k, v in pretrained_state_dict.items():
        if k in model_state_dict:
            if v.shape == model_state_dict[k].shape:  # â† åªåŠ è½½åŒ¹é…çš„
                filtered_state_dict[k] = v
            else:
                skipped_keys.append(...)  # è·³è¿‡ä¸åŒ¹é…çš„
    
    self.load_state_dict(filtered_state_dict, strict=False)
```

**å®é™…æ•ˆæœ**ï¼š
- 26Bæƒé‡ä¸­**å½¢çŠ¶åŒ¹é…**çš„éƒ¨åˆ†ä¼šè¢«åŠ è½½
- 26Bæƒé‡ä¸­**å½¢çŠ¶ä¸åŒ¹é…**çš„éƒ¨åˆ†ä¼šè¢«è·³è¿‡
- è·³è¿‡çš„æƒé‡ä½¿ç”¨8Bæ¶æ„çš„åˆå§‹åŒ–å€¼

---

## ğŸ”¬ è½¬æ¢æ—¥å¿—éªŒè¯

### ä»`convert_to_hf_v2.log`ï¼š

```log
Load pretrained weight from /home/ubuntu/Sa2VA-26B.pth

Skipped 3 mismatched keys due to shape mismatch:
- text_hidden_fcs.0.weight: checkpoint shape [6144, 6144] vs model shape [3584, 3584]
- text_hidden_fcs.2.weight: checkpoint shape [256, 6144] vs model shape [256, 3584]
- ...
```

**è¯´æ˜**ï¼š
- âœ… å¤§éƒ¨åˆ†æƒé‡ä»26BæˆåŠŸåŠ è½½ï¼ˆå½¢çŠ¶åŒ¹é…çš„ï¼‰
- âŒ å°‘æ•°æƒé‡è·³è¿‡ï¼ˆå½¢çŠ¶ä¸åŒ¹é…ï¼Œå¦‚projectorï¼‰
- è·³è¿‡çš„æƒé‡æ•°é‡ï¼š3ä¸ª

---

## ğŸ“Š æƒé‡æ¥æºåˆ†è§£

| æ¨¡å— | å‚æ•°é‡ | æ¥æº | è¯´æ˜ |
|------|--------|------|------|
| **Vision Encoder** | 6B | Sa2VA-26B.pth | âœ… å®Œå…¨åŒ¹é…ï¼Œå…¨éƒ¨åŠ è½½ |
| **LLM (å‰30å±‚)** | ~6B | Sa2VA-26B.pth | âœ… å®Œå…¨åŒ¹é…ï¼Œå…¨éƒ¨åŠ è½½ |
| **LLM (å10å±‚)** | ~2B | Sa2VA-26B.pth | âœ… å®Œå…¨åŒ¹é…ï¼Œå…¨éƒ¨åŠ è½½ |
| **Projector** | ~10M | **8Båˆå§‹åŒ–** | âŒ å½¢çŠ¶ä¸åŒ¹é…ï¼Œè·³è¿‡ |
| **SAM2 Decoder** | 200M | SAM2å®˜æ–¹æƒé‡ | âœ… ç‹¬ç«‹åŠ è½½ |

---

## ğŸ’¡ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

### å®˜æ–¹Sa2VAæ¨¡å‹ç³»åˆ—

| æ¨¡å‹ | Vision | Language | æ€»å‚æ•° |
|------|--------|----------|--------|
| Sa2VA-1B | InternViT-300M | Qwen2.5-0.5B | 1B |
| Sa2VA-4B | InternViT-6B | Qwen2.5-3B | 4B |
| Sa2VA-8B | InternViT-6B | InternLM2-7B | 8B |
| **Sa2VA-26B** | InternViT-6B | InternLM2-20B | 26B |

**è®­ç»ƒç­–ç•¥**ï¼š
1. **ByteDanceå®˜æ–¹**ï¼šå…ˆè®­ç»ƒå¤§æ¨¡å‹ï¼ˆ26Bï¼‰
2. **æ‚¨çš„è®­ç»ƒ**ï¼šä½¿ç”¨26Bé¢„è®­ç»ƒæƒé‡åˆå§‹åŒ–8Bæ¨¡å‹
3. **ç›®çš„**ï¼šåˆ©ç”¨å¤§æ¨¡å‹çš„çŸ¥è¯†è¿ç§»åˆ°å°æ¨¡å‹

---

## ğŸ¯ ç»“è®º

### æ‚¨è®­ç»ƒçš„æ˜¯ä»€ä¹ˆï¼Ÿ

**å‡†ç¡®æè¿°**ï¼š
```
æ¶æ„ï¼šInternVL3-8B (æ€»å‚æ•° ~14B)
â”œâ”€â”€ åˆå§‹åŒ–ï¼šå¤§éƒ¨åˆ†æƒé‡æ¥è‡ª Sa2VA-26B.pth
â”œâ”€â”€ å¾®è°ƒï¼šåœ¨OCTè¡€ç®¡æ•°æ®é›†ä¸Šfine-tune
â””â”€â”€ ç»“æœï¼š8Bæ¶æ„çš„æ¨¡å‹ + 26BçŸ¥è¯†è¿ç§»
```

### ä¸ºä»€ä¹ˆæœ‰æ•ˆï¼Ÿ

1. **çŸ¥è¯†è’¸é¦**ï¼š26Bæ¨¡å‹å­¦åˆ°çš„è§†è§‰-è¯­è¨€å¯¹é½çŸ¥è¯†
2. **å‚æ•°å…±äº«**ï¼šVision Encoderåœ¨26Bå’Œ8Bä¸­æ˜¯ç›¸åŒçš„ï¼ˆéƒ½æ˜¯6Bï¼‰
3. **å½¢çŠ¶åŒ¹é…**ï¼šLLMçš„embeddingå±‚ã€å‰å‡ å±‚ç­‰ç»“æ„ç›¸ä¼¼

### å®é™…å‚æ•°é‡

- **æ¨¡å‹æ¶æ„**ï¼š8B (InternVL3-8B)
- **é¢„è®­ç»ƒåˆå§‹åŒ–**ï¼šæ¥è‡ª26Bæ¨¡å‹çš„åŒ¹é…æƒé‡
- **è®­ç»ƒcheckpointå¤§å°**ï¼š2.5GB (åªä¿å­˜è®­ç»ƒæ›´æ–°çš„å‚æ•°)
- **å®Œæ•´HFæ¨¡å‹å¤§å°**ï¼š30GB (åŒ…å«æ‰€æœ‰æƒé‡)

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å¯èƒ½çš„æ··æ·†

1. **é…ç½®æ³¨é‡Šè¯´"ä½¿ç”¨InternVL3-8B"** âœ… æ­£ç¡®
2. **é…ç½®åŠ è½½"Sa2VA-26B.pth"** âœ… ä¹Ÿæ­£ç¡®ï¼ˆé¢„è®­ç»ƒåˆå§‹åŒ–ï¼‰
3. **æ—¥å¿—æ˜¾ç¤º"34.52GB Sa2VA-26B"** âš ï¸ è¯¯å¯¼æ€§ï¼ˆå®é™…æ˜¯8Bæ¶æ„ï¼‰

### å‡†ç¡®è¯´æ³•

**æ‚¨è®­ç»ƒçš„æ¨¡å‹åº”è¯¥ç§°ä¸º**ï¼š
- "Sa2VA-8B with 26B pretraining" âœ…
- æˆ– "Sa2VA-InternVL3-8B (26B-init)" âœ…

**ä¸å‡†ç¡®çš„è¯´æ³•**ï¼š
- "Sa2VA-26B" âŒ (æ¶æ„ä¸æ˜¯26B)
- "çº¯8Bæ¨¡å‹" âŒ (ç”¨äº†26Bé¢„è®­ç»ƒ)

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- é…ç½®ï¼š`projects/sa2va/configs/sa2va_vessel_finetune.py`
- æ¨¡å‹ï¼š`projects/sa2va/models/sa2va.py` (ç¬¬72-87è¡Œ)
- æ—¥å¿—ï¼š`convert_to_hf_v2.log`

**åˆ›å»ºæ—¶é—´**ï¼š2025-11-27  
**ç»“è®º**ï¼š8Bæ¶æ„ + 26Bé¢„è®­ç»ƒæƒé‡åˆå§‹åŒ–
