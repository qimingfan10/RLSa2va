# 🎬 5个视频序列预测说明

## 📝 修改内容

### 原始脚本 vs 新脚本

**原始**: `predict_video.py`
- 只预测1个视频序列
- 输出到单个目录

**新版**: `predict_5_videos.py` ✨
- **预测5个视频序列**
- 为每个视频创建独立输出目录
- 生成综合报告

---

## 🎯 主要改进

### 1. 多视频支持
```python
# 配置
NUM_VIDEOS = 5              # 预测5个视频
START_VIDEO_INDEX = 0       # 从第0个视频开始
```

### 2. 独立输出目录
```
video_prediction_5_videos/
├── video_00_{name}/
│   ├── video_00_4panel_comparison.mp4
│   ├── video_00_results.json
│   └── frames/
├── video_01_{name}/
├── video_02_{name}/
├── video_03_{name}/
├── video_04_{name}/
├── summary_5_videos.json
└── SUMMARY_5_VIDEOS.md
```

### 3. 综合报告

**JSON格式** (`summary_5_videos.json`):
```json
{
  "num_videos": 5,
  "total_frames": 150,
  "overall_avg_iou": 0.67,
  "overall_avg_dice": 0.80,
  "videos": [
    {
      "video_index": 0,
      "video_name": "Chen_Fang_0000103366__1-2_1_04B2D3CD",
      "num_frames": 30,
      "avg_metrics": {"IoU": 0.68, "Dice": 0.81}
    },
    ...
  ]
}
```

**Markdown格式** (`SUMMARY_5_VIDEOS.md`):
- 总体性能统计
- 各视频详细对比表格
- 输出文件清单

---

## 🚀 如何运行

### 方法1: 使用脚本（推荐）
```bash
cd /home/ubuntu/Sa2VA
chmod +x run_predict_5_videos.sh
bash run_predict_5_videos.sh
```

### 方法2: 直接运行
```bash
# 激活环境
eval "$(micromamba shell hook --shell bash)"
micromamba activate topo-sarl

# 运行预测
cd /home/ubuntu/Sa2VA
python predict_5_videos.py
```

---

## ⏱️ 预计时间

根据视频长度不同：
- **短视频** (3-10帧): ~2分钟/视频
- **中等视频** (10-30帧): ~5分钟/视频
- **长视频** (30+帧): ~10分钟/视频

**总计**: 约 **10-15分钟** 完成5个视频

---

## 📊 输出内容

### 每个视频的输出

1. **4-panel对比MP4视频**
   - 左上: 原始图像
   - 右上: Ground Truth (绿色)
   - 左下: 预测结果 (红色)
   - 右下: IoU显示

2. **JSON结果**
   - 平均指标
   - 逐帧指标
   - 成功率统计

### 综合输出

1. **summary_5_videos.json**
   - 5个视频的完整数据
   - 总体统计信息

2. **SUMMARY_5_VIDEOS.md**
   - 可读性强的报告
   - 对比表格

---

## 🔍 查看结果

### 快速查看
```bash
# 查看Markdown报告
cat video_prediction_5_videos/SUMMARY_5_VIDEOS.md

# 列出所有MP4
ls video_prediction_5_videos/video_*/*.mp4

# 查看综合JSON
cat video_prediction_5_videos/summary_5_videos.json | jq .
```

### 详细查看
```bash
# 查看某个视频的详细结果
cat video_prediction_5_videos/video_00_*/video_00_results.json | jq .

# 播放某个视频
# (需要下载到本地用视频播放器查看)
```

---

## 📋 示例输出

### 控制台输出
```
==============================================================================
Sa2VA 5个视频序列预测
==============================================================================

找到 50 个视频序列（>=3帧）

✅ 将预测 5 个视频 (索引 0 到 4)
  #0. Chen_Fang_0000103366__1-2_1_04B2D3CD: 30帧
  #1. Chen_Fang_0000103366__1-4_1_04B2D3CF: 28帧
  #2. Chen_Fang_0000103366__1-6_1_04B2D3D1: 25帧
  #3. Bai_Hui_Min_0000202318__1-3_1_04DB6FD9: 32帧
  #4. Gong_Chao_0000838952__1-2_1_0487E196: 27帧

==============================================================================
步骤2: 加载HuggingFace模型
==============================================================================
✅ Tokenizer加载成功
✅ 模型加载成功

==============================================================================
正在处理视频 #0: Chen_Fang_0000103366__1-2_1_04B2D3CD
  总帧数: 30
==============================================================================
视频0推理: 100%|████████████████| 30/30 [02:15<00:00, 0.22it/s]

✅ 视频 #0 推理完成!
   成功: 30/30
   成功率: 100.0%
   
视频 #0 平均指标:
   IoU: 0.6820
   Dice: 0.8112

...（对其余4个视频重复）

==============================================================================
步骤4: 生成综合报告
==============================================================================

总体统计:
  预测视频数: 5
  总帧数: 142
  成功帧数: 142
  总成功率: 100.0%
  平均IoU: 0.6725
  平均Dice: 0.8005

✅ 5个视频预测完成！
```

### Markdown报告示例
```markdown
# Sa2VA 5个视频预测结果总结

**模型**: `/home/ubuntu/Sa2VA/models/sa2va_vessel_hf`

**预测时间**: 142 帧来自 5 个视频

## 总体性能

- **总成功率**: 100.00% (142/142)
- **平均IoU**: 0.6725
- **平均Dice**: 0.8005

## 各视频详细结果

| 视频# | 视频名称 | 帧数 | 成功率 | IoU | Dice |
|------|---------|------|--------|-----|------|
| 0 | Chen_Fang_0000103366__1-2_1_04B2D3CD | 30 | 100.0% | 0.6820 | 0.8112 |
| 1 | Chen_Fang_0000103366__1-4_1_04B2D3CF | 28 | 100.0% | 0.6750 | 0.8050 |
| 2 | Chen_Fang_0000103366__1-6_1_04B2D3D1 | 25 | 100.0% | 0.6690 | 0.8010 |
| 3 | Bai_Hui_Min_0000202318__1-3_1_04DB6FD9 | 32 | 100.0% | 0.6580 | 0.7920 |
| 4 | Gong_Chao_0000838952__1-2_1_0487E196 | 27 | 100.0% | 0.6785 | 0.8083 |
```

---

## 🎨 4-Panel视频说明

每个MP4视频包含4个面板：

```
┌─────────────┬─────────────┐
│  Original   │ Ground Truth│
│   (原图)     │   (绿色)     │
├─────────────┼─────────────┤
│ Prediction  │ IoU Display │
│   (红色)     │  (指标)      │
└─────────────┴─────────────┘
```

- **左上**: 原始OCT图像
- **右上**: Ground Truth标注（绿色叠加）
- **左下**: 模型预测结果（红色叠加）
- **右下**: IoU数值显示

---

## 💡 下一步

### 如果需要预测更多视频
修改配置：
```python
NUM_VIDEOS = 10             # 预测10个视频
START_VIDEO_INDEX = 5       # 从第5个开始
```

### 如果需要不同的视频类型
可以添加其他视频类型：
- `gt_only`: 只有Ground Truth叠加
- `pred_only`: 只有预测叠加
- `side_by_side`: 左右对比

---

## 📞 需要帮助？

如果遇到问题：

1. 查看完整日志
   ```bash
   cat video_prediction_5_videos.log
   ```

2. 检查磁盘空间
   ```bash
   df -h /home/ubuntu
   ```

3. 检查GPU内存
   ```bash
   nvidia-smi
   ```

---

**创建时间**: 2025-11-25 19:38  
**状态**: 就绪，等待运行  
**预计完成**: 10-15分钟
