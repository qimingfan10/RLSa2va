# æ•°æ®é›†ç»“æ„è¯´æ˜

## ğŸ“ ä½¿ç”¨çš„æ•°æ®é›†ä½ç½®

### æ•°æ®é›†è·¯å¾„
```
/home/ubuntu/Sa2VA/data/merged_vessel_data/
```

### ç›®å½•ç»“æ„
```
merged_vessel_data/
â”œâ”€â”€ annotations.json          # 22MB - æ‰€æœ‰æ ‡æ³¨ä¿¡æ¯
â””â”€â”€ images/                   # 81MB - 1220å¼ å›¾ç‰‡
    â”œâ”€â”€ An Cong Xue(0000932433)_1-3_1_051C3E6A_frame_000011.jpg
    â”œâ”€â”€ An Cong Xue(0000932433)_1-3_1_051C3E6A_frame_000012.jpg
    â”œâ”€â”€ ...
    â””â”€â”€ (å…±1220å¼ 512Ã—512çš„å›¾ç‰‡)
```

### é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„
```python
# åœ¨ sa2va_merged_vessel_finetune.py ä¸­
DATA_ROOT = '/home/ubuntu/Sa2VA/data/'
MERGED_VESSEL_ROOT = DATA_ROOT + 'merged_vessel_data/'

sa2va_merged_vessel_finetune_configs = [
    dict(
        type=Sa2VAFinetuneDataset,
        data_root=MERGED_VESSEL_ROOT,           # /home/ubuntu/Sa2VA/data/merged_vessel_data/
        data_prefix=dict(img_path='images/'),   # images/å­ç›®å½•
        ann_file='annotations.json',            # æ ‡æ³¨æ–‡ä»¶
        ...
    )
]
```

---

## â“ ä¸ºä»€ä¹ˆmaskæ•°é‡æ¯”æ ·æœ¬æ•°å¤šï¼Ÿ

### æ ¸å¿ƒæ¦‚å¿µ

**æ ·æœ¬ â‰  mask**

- **æ ·æœ¬ï¼ˆSampleï¼‰**: ä¸€å¼ å›¾ç‰‡
- **mask**: å›¾ç‰‡ä¸­çš„ä¸€ä¸ªè¡€ç®¡åŒºåŸŸ

### æ•°é‡å¯¹æ¯”

```
æ ·æœ¬æ•°ï¼ˆå›¾ç‰‡æ•°ï¼‰: 1220å¼ 
maskæ€»æ•°: 1733ä¸ª
å·®å¼‚: 513ä¸ª (å¤šå‡º42%)
```

### åŸå› ï¼šä¸€å¼ å›¾ç‰‡å¯ä»¥åŒ…å«å¤šæ¡è¡€ç®¡ï¼

åœ¨åŒ»å­¦å½±åƒä¸­ï¼Œä¸€å¼ å›¾ç‰‡é€šå¸¸åŒ…å«å¤šæ¡è¡€ç®¡ï¼Œæ¯æ¡è¡€ç®¡éœ€è¦å•ç‹¬æ ‡æ³¨ï¼š

```
å›¾ç‰‡1.jpg
â”œâ”€â”€ mask_0: ä¸»åŠ¨è„‰
â”œâ”€â”€ mask_1: åˆ†æ”¯è¡€ç®¡A
â”œâ”€â”€ mask_2: åˆ†æ”¯è¡€ç®¡B
â””â”€â”€ mask_3: åˆ†æ”¯è¡€ç®¡C
```

---

## ğŸ“Š è¯¦ç»†ç»Ÿè®¡

### Maskåˆ†å¸ƒ

| æ¯å¼ å›¾ç‰‡çš„maskæ•° | å›¾ç‰‡æ•°é‡ | å æ¯” | æ€»maskæ•° |
|----------------|---------|------|---------|
| 1ä¸ªmask | 1047å¼  | 85.8% | 1047 |
| 2ä¸ªmask | 58å¼  | 4.8% | 116 |
| 3ä¸ªmask | 40å¼  | 3.3% | 120 |
| 4ä¸ªmask | 31å¼  | 2.5% | 124 |
| 5ä¸ªmask | 8å¼  | 0.7% | 40 |
| 6ä¸ªmask | 11å¼  | 0.9% | 66 |
| 7ä¸ªmask | 9å¼  | 0.7% | 63 |
| 8ä¸ªmask | 4å¼  | 0.3% | 32 |
| 9ä¸ªmask | 7å¼  | 0.6% | 63 |
| 10ä¸ªmask | 3å¼  | 0.2% | 30 |
| 11ä¸ªmask | 1å¼  | 0.1% | 11 |
| 21ä¸ªmask | 1å¼  | 0.1% | 21 |
| **æ€»è®¡** | **1220å¼ ** | **100%** | **1733** |

### å…³é”®å‘ç°

1. **å¤§å¤šæ•°å›¾ç‰‡åªæœ‰1ä¸ªmask** (85.8%)
   - è¿™äº›å›¾ç‰‡ä¸­åªæœ‰ä¸€æ¡ä¸»è¦è¡€ç®¡

2. **14.2%çš„å›¾ç‰‡æœ‰å¤šä¸ªmask** (173å¼ )
   - è¿™äº›å›¾ç‰‡åŒ…å«å¤šæ¡è¡€ç®¡æˆ–è¡€ç®¡åˆ†æ”¯

3. **æœ€å¤šçš„ä¸€å¼ å›¾ç‰‡æœ‰21ä¸ªmask**
   - å¯èƒ½æ˜¯å¤æ‚çš„è¡€ç®¡ç½‘ç»œ

4. **å¹³å‡æ¯å¼ å›¾ç‰‡1.42ä¸ªmask**
   - 1733 / 1220 = 1.42

---

## ğŸ” å®é™…ä¾‹å­

### å•maskå›¾ç‰‡ (85.8%)
```json
{
  "image": "simple_vessel.jpg",
  "mask": [
    [x1, y1, x2, y2, x3, y3, ...]  // ä¸€æ¡è¡€ç®¡çš„å¤šè¾¹å½¢åæ ‡
  ],
  "text": ["blood vessel"]
}
```

### å¤šmaskå›¾ç‰‡ (14.2%)
```json
{
  "image": "An Cong Xue(0000932433)_1-3_1_051C3E6A_frame_000011.jpg",
  "mask": [
    [x1, y1, x2, y2, ...],  // è¡€ç®¡1: 41ä¸ªç‚¹
    [x1, y1, x2, y2, ...],  // è¡€ç®¡2: 184ä¸ªç‚¹
    [x1, y1, x2, y2, ...],  // è¡€ç®¡3: 90ä¸ªç‚¹
    [x1, y1, x2, y2, ...]   // è¡€ç®¡4: 58ä¸ªç‚¹
  ],
  "text": [
    "blood vessel",
    "blood vessel", 
    "blood vessel",
    "blood vessel"
  ]
}
```

---

## ğŸ¯ è®­ç»ƒæ—¶å¦‚ä½•å¤„ç†ï¼Ÿ

### æ•°æ®åŠ è½½

åœ¨`Sa2VAFinetuneDataset`ä¸­ï¼š

```python
def _parse_annotations(self, data_dict):
    # è¯»å–å›¾ç‰‡
    image = data_dict['img_path']  # 1å¼ å›¾ç‰‡
    
    # è¯»å–æ‰€æœ‰mask
    masks = data_dict['mask']      # å¯èƒ½æœ‰å¤šä¸ªmask
    texts = data_dict['text']      # å¯¹åº”çš„æ–‡æœ¬æ ‡ç­¾
    
    # ä¸ºæ¯ä¸ªmaskåˆ›å»ºäºŒå€¼mask
    for obj_mask, phrase in zip(masks, texts):
        # å¤„ç†å•ä¸ªmaskçš„å¤šè¾¹å½¢åæ ‡
        binary_mask = self._polygon_to_mask(obj_mask, height, width)
        masks.append(binary_mask)
    
    return masks  # è¿”å›æ‰€æœ‰mask
```

### è®­ç»ƒæ ·æœ¬

**1ä¸ªè®­ç»ƒæ ·æœ¬ = 1å¼ å›¾ç‰‡ + è¯¥å›¾ç‰‡çš„æ‰€æœ‰mask**

```
æ ·æœ¬1: å›¾ç‰‡A.jpg + 1ä¸ªmask
æ ·æœ¬2: å›¾ç‰‡B.jpg + 4ä¸ªmask
æ ·æœ¬3: å›¾ç‰‡C.jpg + 2ä¸ªmask
...
æ ·æœ¬1220: å›¾ç‰‡Z.jpg + 21ä¸ªmask
```

æ¨¡å‹ä¼šå­¦ä¹ ï¼š
- è¾“å…¥ï¼šä¸€å¼ å›¾ç‰‡ + æ–‡æœ¬æç¤º"blood vessel"
- è¾“å‡ºï¼šè¯¥å›¾ç‰‡ä¸­æ‰€æœ‰è¡€ç®¡çš„åˆ†å‰²mask

---

## ğŸ’¡ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

### 1. ç¬¦åˆåŒ»å­¦å½±åƒç‰¹ç‚¹
- åŒ»å­¦å›¾åƒé€šå¸¸åŒ…å«å¤šä¸ªæ„Ÿå…´è¶£åŒºåŸŸ
- æ¯æ¡è¡€ç®¡éƒ½éœ€è¦ç²¾ç¡®åˆ†å‰²
- ä¸åŒè¡€ç®¡å¯èƒ½æœ‰ä¸åŒçš„ä¸´åºŠæ„ä¹‰

### 2. æé«˜æ ‡æ³¨æ•ˆç‡
- ä¸€æ¬¡æ ‡æ³¨ä¸€å¼ å›¾ç‰‡çš„æ‰€æœ‰è¡€ç®¡
- é¿å…é‡å¤åŠ è½½åŒä¸€å¼ å›¾ç‰‡
- å‡å°‘å­˜å‚¨ç©ºé—´

### 3. è®­ç»ƒæ•ˆç‡
- ä¸€æ¬¡forwardå¤„ç†ä¸€å¼ å›¾ç‰‡çš„æ‰€æœ‰mask
- å……åˆ†åˆ©ç”¨å›¾åƒç‰¹å¾
- æé«˜GPUåˆ©ç”¨ç‡

---

## ğŸ“ˆ å¯¹è®­ç»ƒçš„å½±å“

### Iterè®¡ç®—
```
æ€»iteræ•° = å›¾ç‰‡æ•° Ã— epochs / batch_size
        = 1220 Ã— 3 / 1
        â‰ˆ 3672æ­¥
```

**æ³¨æ„**: IteråŸºäº**å›¾ç‰‡æ•°**ï¼Œä¸æ˜¯maskæ•°ï¼

### Lossè®¡ç®—
```python
# å¯¹ä¸€å¼ å›¾ç‰‡çš„æ‰€æœ‰maskè®¡ç®—loss
for mask in masks:
    loss_mask += compute_mask_loss(pred_mask, gt_mask)
    loss_dice += compute_dice_loss(pred_mask, gt_mask)

# å¹³å‡loss
loss_mask /= len(masks)
loss_dice /= len(masks)
```

### è®­ç»ƒæ—¶é—´
- å¤šmaskå›¾ç‰‡éœ€è¦æ›´å¤šè®¡ç®—æ—¶é—´
- ä½†æ€»ä½“è®­ç»ƒæ—¶é—´ä»åŸºäºå›¾ç‰‡æ•°
- å¹³å‡æ¯å¼ å›¾ç‰‡~16ç§’

---

## ğŸ—‚ï¸ åŸå§‹æ•°æ®æ¥æº

æ•°æ®é›†æ˜¯ä»ä»¥ä¸‹ä½ç½®å‡†å¤‡çš„ï¼š

```
åŸå§‹æ•°æ®: /home/ubuntu/Sa2VA/Segment_DATA_Merged_512/
â”œâ”€â”€ images/          # 1220å¼ 512Ã—512å›¾ç‰‡
â”œâ”€â”€ masks/           # (æœªä½¿ç”¨ï¼Œå·²è½¬ä¸ºå¤šè¾¹å½¢)
â””â”€â”€ json/            # 1220ä¸ªLabelMeæ ¼å¼çš„JSONæ–‡ä»¶
    â”œâ”€â”€ image1.json  # åŒ…å«è¯¥å›¾ç‰‡çš„æ‰€æœ‰æ ‡æ³¨
    â”œâ”€â”€ image2.json
    â””â”€â”€ ...

å¤„ç†å: /home/ubuntu/Sa2VA/data/merged_vessel_data/
â”œâ”€â”€ images/          # å¤åˆ¶çš„å›¾ç‰‡
â””â”€â”€ annotations.json # åˆå¹¶çš„æ ‡æ³¨æ–‡ä»¶
```

å‡†å¤‡è„šæœ¬: `prepare_merged_dataset.py`

---

## ğŸ“ æ€»ç»“

### å…³é”®ç‚¹

1. **æ•°æ®é›†ä½ç½®**: `/home/ubuntu/Sa2VA/data/merged_vessel_data/`

2. **æ ·æœ¬ vs Mask**:
   - æ ·æœ¬æ•° = å›¾ç‰‡æ•° = 1220
   - Maskæ•° = è¡€ç®¡åŒºåŸŸæ•° = 1733
   - ä¸€å¼ å›¾ç‰‡å¯ä»¥æœ‰å¤šä¸ªmask

3. **ä¸ºä»€ä¹ˆå¤š**:
   - åŒ»å­¦å›¾åƒåŒ…å«å¤šæ¡è¡€ç®¡
   - æ¯æ¡è¡€ç®¡å•ç‹¬æ ‡æ³¨
   - å¹³å‡æ¯å¼ å›¾ç‰‡1.42ä¸ªmask

4. **è®­ç»ƒå½±å“**:
   - IteråŸºäºå›¾ç‰‡æ•°ï¼Œä¸æ˜¯maskæ•°
   - å¤šmaskå›¾ç‰‡è®¡ç®—é‡æ›´å¤§
   - ä½†è®­ç»ƒé€»è¾‘ä¿æŒä¸€è‡´

---

**åˆ›å»ºæ—¶é—´**: 2025-11-25  
**æ•°æ®é›†**: Segment_DATA_Merged_512 â†’ merged_vessel_data
