# ğŸš€ å®éªŒä¸‰æ­¥éª¤2ï¼šä½¿ç”¨Reward Networkå¾®è°ƒSa2VA

## ğŸ“‹ æ¦‚è¿°

æ­¥éª¤2ä½¿ç”¨åœ¨æ­¥éª¤1ä¸­è®­ç»ƒå¥½çš„Reward Networkä½œä¸ºå¥–åŠ±å‡½æ•°ï¼Œé€šè¿‡å¼ºåŒ–å­¦ä¹ ï¼ˆPPOç®—æ³•ï¼‰æ¥å¾®è°ƒSa2VAæ¨¡å‹ï¼Œç›´æ¥ä¼˜åŒ–åˆ†å‰²è´¨é‡ã€‚

---

## ğŸ¯ ç›®æ ‡

- **è¾“å…¥**: è®­ç»ƒå¥½çš„Reward Network + Sa2VAæ¨¡å‹
- **è¾“å‡º**: ä¼˜åŒ–åçš„Sa2VAæ¨¡å‹
- **ç›®æ ‡**: Diceä»0.8191æå‡åˆ°0.85+ï¼ŒRecallä»0.7763æå‡åˆ°0.85+

---

## ğŸ”§ å®ç°åŸç†

### å¼ºåŒ–å­¦ä¹ è®¾ç½®

```
ç¯å¢ƒ (Environment):
  çŠ¶æ€: è¾“å…¥å›¾åƒçš„ç‰¹å¾
  åŠ¨ä½œ: é€‰æ‹©promptï¼ˆ11ä¸ªå€™é€‰ï¼‰
  å¥–åŠ±: Reward Networkè¯„ä¼°åˆ†æ•°

Agent: PPOç®—æ³•
  ç­–ç•¥ç½‘ç»œ: MLP (128â†’64)
  ä»·å€¼ç½‘ç»œ: MLP (128â†’64)
```

### è®­ç»ƒæµç¨‹

```
1. åŠ è½½Reward Network (å·²è®­ç»ƒå¥½)
2. åŠ è½½Sa2VAæ¨¡å‹
3. åˆ›å»ºRLç¯å¢ƒ
4. PPOè®­ç»ƒå¾ªç¯:
   For each step:
     - ä»ç¯å¢ƒè·å–å›¾åƒ
     - Agenté€‰æ‹©prompt
     - Sa2VAç”Ÿæˆé¢„æµ‹mask
     - Reward Networkè¯„åˆ† â†’ å¥–åŠ±
     - PPOæ›´æ–°ç­–ç•¥
5. ä¿å­˜ä¼˜åŒ–åçš„ç­–ç•¥
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### Quickæµ‹è¯•ï¼ˆæ¨èï¼‰

```bash
# å¿«é€Ÿæµ‹è¯•ï¼ˆ20å¼ å›¾åƒï¼Œ2000æ­¥ï¼Œ~5-10åˆ†é’Ÿï¼‰
bash /home/ubuntu/Sa2VA/rl_reward_network/run_step2_finetune.sh quick
```

### å®Œæ•´è®­ç»ƒ

```bash
# å®Œæ•´è®­ç»ƒï¼ˆ100å¼ å›¾åƒï¼Œ10000æ­¥ï¼Œ~30-60åˆ†é’Ÿï¼‰
bash /home/ubuntu/Sa2VA/rl_reward_network/run_step2_finetune.sh full
```

---

## ğŸ“Š å‚æ•°é…ç½®

### Quickæ¨¡å¼
```yaml
è®­ç»ƒæ ·æœ¬: 20å¼ 
æ€»æ­¥æ•°: 2000
å¹¶è¡Œç¯å¢ƒ: 2ä¸ª
å­¦ä¹ ç‡: 3e-4
Batch Size: 64
GPU: GPU1
é¢„è®¡æ—¶é—´: 5-10åˆ†é’Ÿ
```

### Fullæ¨¡å¼
```yaml
è®­ç»ƒæ ·æœ¬: 100å¼ 
æ€»æ­¥æ•°: 10000
å¹¶è¡Œç¯å¢ƒ: 4ä¸ª
å­¦ä¹ ç‡: 3e-4
Batch Size: 64
GPU: GPU1
é¢„è®¡æ—¶é—´: 30-60åˆ†é’Ÿ
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
rl_reward_network/
â”œâ”€â”€ env/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ sa2va_finetune_env.py         â† RLç¯å¢ƒå®šä¹‰
â”œâ”€â”€ models/
â”‚   â””â”€â”€ reward_network.py             â† Reward Network
â”œâ”€â”€ outputs/
â”‚   â”œâ”€â”€ reward_net_20251129_132402/   â† æ­¥éª¤1çš„Reward Network
â”‚   â””â”€â”€ sa2va_rl_finetune_*/          â† æ­¥éª¤2çš„è¾“å‡º
â”œâ”€â”€ finetune_sa2va_with_rl.py         â† è®­ç»ƒè„šæœ¬
â”œâ”€â”€ run_step2_finetune.sh             â† è¿è¡Œè„šæœ¬
â””â”€â”€ STEP2_README.md                   â† æœ¬æ–‡ä»¶
```

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### Reward Networkä½œä¸ºå¥–åŠ±å‡½æ•°

**ä¼ ç»ŸRLé—®é¢˜**ï¼š
```python
# éœ€è¦Ground Truth
reward = dice_score(pred_mask, gt_mask)
é—®é¢˜: æµ‹è¯•æ—¶æ²¡æœ‰GT
```

**æˆ‘ä»¬çš„æ–¹æ¡ˆ**ï¼š
```python
# ä½¿ç”¨å­¦ä¹ åˆ°çš„è¯„ä¼°å™¨
reward = reward_network(image, pred_mask)
ä¼˜åŠ¿: 
  âœ… ä¸éœ€è¦GT
  âœ… å¯å¾®åˆ†
  âœ… ç»¼åˆå¤šæŒ‡æ ‡
```

### RLç¯å¢ƒè®¾è®¡

```python
class Sa2VAFinetuneEnv:
    çŠ¶æ€ç©ºé—´: 
      - å›¾åƒç»Ÿè®¡ç‰¹å¾ (16ç»´)
      - æ¢¯åº¦ç‰¹å¾
      - å½“å‰è¿›åº¦
    
    åŠ¨ä½œç©ºé—´:
      - ç¦»æ•£åŠ¨ä½œ: 11ä¸ªprompté€‰æ‹©
    
    å¥–åŠ±å‡½æ•°:
      - Reward Networkè¯„åˆ† (ä¸»è¦)
      - GT Diceåˆ†æ•° (å‚è€ƒ)
```

### PPOç®—æ³•é…ç½®

```python
PPOå‚æ•°:
  - Learning Rate: 3e-4
  - Gamma: 0.99 (æŠ˜æ‰£å› å­)
  - GAE Lambda: 0.95
  - Clip Range: 0.2
  - Entropy Coef: 0.01
  - Value Function Coef: 0.5
```

---

## ğŸ“Š ç›‘æ§è®­ç»ƒ

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹è®­ç»ƒæ—¥å¿—
tail -f /home/ubuntu/Sa2VA/rl_reward_network/logs/step2_finetune_*.log
```

### TensorBoardå¯è§†åŒ–

```bash
# å¯åŠ¨TensorBoardï¼ˆç«¯å£6009ï¼‰
tensorboard --logdir /home/ubuntu/Sa2VA/rl_reward_network/outputs/*/logs --port 6009
```

**å…³é”®æŒ‡æ ‡**ï¼š
- `rollout/ep_rew_mean`: Episodeå¹³å‡å¥–åŠ±
- `rollout/ep_len_mean`: Episodeå¹³å‡é•¿åº¦
- `custom/reward_net_score`: Reward Networkè¯„åˆ†
- `custom/gt_dice`: ä¸GTçš„Diceåˆ†æ•°
- `custom/best_reward`: æœ€ä½³å¥–åŠ±

### æ£€æŸ¥GPU

```bash
# å®æ—¶æŸ¥çœ‹GPUä½¿ç”¨
watch -n 1 nvidia-smi
```

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### ç†è®ºä¸Šé™

æ ¹æ®å®éªŒä¸‰çš„è®¾è®¡ï¼š
```
å½“å‰Dice: 0.8191
é¢„æœŸæå‡: +10-15%
ç›®æ ‡Dice: 0.90-0.93

å½“å‰Recall: 0.7763
é¢„æœŸæå‡: +12-18%
ç›®æ ‡Recall: 0.87-0.92
```

### Quickæ¨¡å¼é¢„æœŸ

```
è®­ç»ƒæ ·æœ¬: 20å¼ 
è®­ç»ƒæ­¥æ•°: 2000
é¢„æœŸæ•ˆæœ: +3-5% Diceæå‡
éªŒè¯å¯è¡Œæ€§: âœ…
```

### Fullæ¨¡å¼é¢„æœŸ

```
è®­ç»ƒæ ·æœ¬: 100å¼ 
è®­ç»ƒæ­¥æ•°: 10000
é¢„æœŸæ•ˆæœ: +8-12% Diceæå‡
ç”Ÿäº§å¯ç”¨: âœ…
```

---

## âš ï¸ é‡è¦è¯´æ˜

### 1. Reward Networkä¾èµ–

**å¿…é¡»å…ˆè¿è¡Œæ­¥éª¤1**ï¼š
```bash
# å¦‚æœè¿˜æ²¡è®­ç»ƒReward Network
bash /home/ubuntu/Sa2VA/rl_reward_network/run_experiment3.sh quick
```

**é»˜è®¤ä½¿ç”¨**ï¼š
```
Quickæ¨¡å¼çš„æœ€ä½³æ¨¡å‹:
/home/ubuntu/Sa2VA/rl_reward_network/outputs/reward_net_20251129_132402/best_reward_net.pth
```

### 2. GPUå†…å­˜éœ€æ±‚

```
æ­¥éª¤2éœ€è¦åŒæ—¶åŠ è½½:
  - Sa2VAæ¨¡å‹ (~15GB)
  - Reward Network (~50MB)
  - RLç­–ç•¥ç½‘ç»œ (~1MB)

æ€»éœ€æ±‚: ~16GB
æ¨è: GPU1 (24GB)
```

### 3. è®­ç»ƒæ—¶é—´

```
Quickæ¨¡å¼:
  - æ•°æ®åŠ è½½: ~30ç§’
  - RLè®­ç»ƒ: ~5åˆ†é’Ÿ
  - æ€»è®¡: ~6åˆ†é’Ÿ

Fullæ¨¡å¼:
  - æ•°æ®åŠ è½½: ~2åˆ†é’Ÿ
  - RLè®­ç»ƒ: ~30åˆ†é’Ÿ
  - æ€»è®¡: ~32åˆ†é’Ÿ
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: Reward Network not found

**é”™è¯¯**ï¼š
```
Reward Networkä¸å­˜åœ¨: .../best_reward_net.pth
```

**è§£å†³**ï¼š
```bash
# å…ˆè¿è¡Œæ­¥éª¤1
bash run_experiment3.sh quick
```

### é—®é¢˜2: CUDA Out of Memory

**é”™è¯¯**ï¼š
```
RuntimeError: CUDA out of memory
```

**è§£å†³**ï¼š
```bash
# æ–¹æ¡ˆ1: å‡å°‘å¹¶è¡Œç¯å¢ƒæ•°
ä¿®æ”¹ run_step2_finetune.sh:
N_ENVS=1  # ä»2æ”¹ä¸º1

# æ–¹æ¡ˆ2: ä½¿ç”¨å…¶ä»–GPU
ä¿®æ”¹ run_step2_finetune.sh:
GPU=2  # æ¢åˆ°GPU2
```

### é—®é¢˜3: è®­ç»ƒè¿›ç¨‹æ„å¤–åœæ­¢

**æ£€æŸ¥**ï¼š
```bash
# æŸ¥çœ‹æ—¥å¿—å°¾éƒ¨
tail -50 /home/ubuntu/Sa2VA/rl_reward_network/logs/step2_finetune_*.log
```

**é‡å¯**ï¼š
```bash
# é‡æ–°è¿è¡Œ
bash run_step2_finetune.sh quick
```

---

## ğŸ“ˆ ä¸å…¶ä»–å®éªŒå¯¹æ¯”

| å®éªŒ | æ–¹æ³• | éš¾åº¦ | é¢„æœŸæå‡ | æ—¶é—´ |
|------|------|------|----------|------|
| **å®éªŒä¸€** | Promptä¼˜åŒ– | â­â­ | +3-5% | ~1å°æ—¶ |
| **å®éªŒäºŒ** | åå¤„ç†ä¼˜åŒ– | â­â­ | +5-10% | ~1å°æ—¶ |
| **å®éªŒä¸‰** | Rewardå¼•å¯¼å¾®è°ƒ | â­â­â­â­â­ | +10-15% | ~30åˆ†é’Ÿ |

**å®éªŒä¸‰çš„ä¼˜åŠ¿**ï¼š
- âœ… ç†è®ºæ•ˆæœæœ€å¥½
- âœ… ç«¯åˆ°ç«¯ä¼˜åŒ–
- âœ… å¯è¿ç§»åˆ°å…¶ä»–ä»»åŠ¡

**å®éªŒä¸‰çš„æŒ‘æˆ˜**ï¼š
- âš ï¸ å®ç°å¤æ‚åº¦é«˜
- âš ï¸ éœ€è¦ä¸¤æ­¥è®­ç»ƒ
- âš ï¸ GPUå†…å­˜éœ€æ±‚å¤§

---

## ğŸ“ ä¸‹ä¸€æ­¥

### è®­ç»ƒå®Œæˆå

1. **è¯„ä¼°æ€§èƒ½**
   ```bash
   # åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°
   python3 evaluate_rl_finetuned_sa2va.py \
       --model_path outputs/sa2va_rl_finetune_*/final_model \
       --split test
   ```

2. **å¯¹æ¯”ä¸‰ä¸ªå®éªŒ**
   - å®éªŒä¸€: Promptä¼˜åŒ–
   - å®éªŒäºŒ: åå¤„ç†ä¼˜åŒ–
   - å®éªŒä¸‰: Rewardå¼•å¯¼å¾®è°ƒ

3. **é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ**
   - æ ¹æ®Diceã€Recallã€Precisionç»¼åˆè¯„ä¼°
   - è€ƒè™‘å®ç°éš¾åº¦å’Œéƒ¨ç½²æˆæœ¬

---

## ğŸ“ æŠ€æœ¯è´¡çŒ®

### åˆ›æ–°ç‚¹

1. **é¦–æ¬¡å°†Reward Networkç”¨äºVLMå¾®è°ƒ**
   - å­¦ä¹ è´¨é‡è¯„ä¼°å‡½æ•°
   - ä½œä¸ºRLå¥–åŠ±ä¿¡å·

2. **æ— éœ€GTçš„åœ¨çº¿ä¼˜åŒ–**
   - ä¼ ç»ŸRLä¾èµ–GT
   - æˆ‘ä»¬çš„æ–¹æ³•å¯åœ¨æ— æ ‡æ³¨æ•°æ®ä¸Šç»§ç»­ä¼˜åŒ–

3. **ç«¯åˆ°ç«¯å¯å¾®ä¼˜åŒ–**
   - æ•´ä¸ªé“¾è·¯å¯å¾®åˆ†
   - æ”¯æŒæ¢¯åº¦ä¼˜åŒ–

### æ½œåœ¨åº”ç”¨

- åŒ»å­¦å›¾åƒåˆ†å‰²
- å…¶ä»–VLMä»»åŠ¡
- è¿ç§»å­¦ä¹ 
- å°‘æ ·æœ¬å­¦ä¹ 

---

## âœ… æ£€æŸ¥æ¸…å•

å¼€å§‹è®­ç»ƒå‰ï¼š
- [ ] æ­¥éª¤1çš„Reward Networkå·²è®­ç»ƒå®Œæˆ
- [ ] Sa2VAæ¨¡å‹æ–‡ä»¶å­˜åœ¨
- [ ] æ•°æ®é›†annotations.jsonå­˜åœ¨
- [ ] GPU1å¯ç”¨ï¼ˆæˆ–é€‰æ‹©å…¶ä»–GPUï¼‰
- [ ] ç£ç›˜ç©ºé—´å……è¶³ï¼ˆè‡³å°‘5GBï¼‰

è®­ç»ƒæœŸé—´ï¼š
- [ ] ç›‘æ§GPUä½¿ç”¨ç‡
- [ ] æŸ¥çœ‹TensorBoardæ›²çº¿
- [ ] æ£€æŸ¥ep_rew_meanæ˜¯å¦ä¸Šå‡
- [ ] ç¡®è®¤æ²¡æœ‰OOMé”™è¯¯

è®­ç»ƒå®Œæˆåï¼š
- [ ] æ£€æŸ¥final_modelå·²ä¿å­˜
- [ ] è¯„ä¼°æµ‹è¯•é›†æ€§èƒ½
- [ ] ä¸baselineå¯¹æ¯”
- [ ] è®°å½•æœ€ç»ˆæŒ‡æ ‡

---

**å¼€å§‹è®­ç»ƒ**ï¼š
```bash
bash /home/ubuntu/Sa2VA/rl_reward_network/run_step2_finetune.sh quick
```

**ç¥è®­ç»ƒé¡ºåˆ©ï¼** ğŸš€
